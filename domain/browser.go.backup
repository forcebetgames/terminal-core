package domain

import (
	"context"
	"fmt"
	"log"
	"os"
	"strconv"
	"time"

	"github.com/chromedp/cdproto/emulation"
	"github.com/chromedp/cdproto/input"
	"github.com/chromedp/cdproto/network"
	"github.com/chromedp/cdproto/page"
	"github.com/chromedp/chromedp"
)

func OpenBrowser(url string, globalCTX context.Context) (context.Context, context.CancelFunc) {
	headers := map[string]any{
		"X-Custom-keyevent": "potato",
	}

	// Detectar orienta√ß√£o antes de criar o navegador
	orientation := os.Getenv("SCREEN_ORIENTATION")
	if orientation == "" {
		orientation = "portrait" // Padr√£o: vertical (Tigrinho)
	}

	// Detectar se DevTools deve estar habilitado
	enableDevTools := os.Getenv("ENABLE_DEVTOOLS") == "true"

	// User-Agent baseado na orienta√ß√£o
	var userAgent string
	if orientation == "portrait" {
		// User-Agent mobile (simula dispositivo m√≥vel vertical)
		userAgent = "Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/537.36 (KHTML, like Gecko) Version/14.0 Mobile/15E148 Safari/537.36"
		log.Println("üîß User-Agent: Mobile (iPhone - Portrait)")
	} else {
		// User-Agent desktop padr√£o
		userAgent = "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
		log.Println("üîß User-Agent: Desktop (Landscape)")
	}

	if enableDevTools {
		log.Println("üêõ DevTools HABILITADO - Modo Debug")
		log.Println("   Pressione F12 para abrir DevTools")
	} else {
		log.Println("üîí DevTools DESABILITADO - Modo Produ√ß√£o (Kiosk)")
	}
	log.Println("üîß Wayland Fix: For√ßando XWayland (ozone-platform=x11)")

	opts := append(chromedp.DefaultExecAllocatorOptions[:],
		// Define User-Agent dinamicamente
		chromedp.UserAgent(userAgent),

		// Executa o Chrome com a interface gr√°fica (n√£o em modo headless)
		// FOR√áA XWAYLAND - Solu√ß√£o para bug do ChromeDP no Wayland
		// ChromeDP n√£o repassa eventos de pointer/touch do compositor Wayland
		// For√ßando X11, os eventos passam pela camada XWayland corretamente
		chromedp.Flag("ozone-platform", "x11"),

		chromedp.Flag("headless", false),

		// Ativa o √°udio do navegador
		chromedp.Flag("mute-audio", false),

		// Roda o Chrome no modo kiosk (tela cheia sem controles do navegador)
		// DESABILITADO se DevTools estiver ativo (kiosk bloqueia F12)
		chromedp.Flag("kiosk", !enableDevTools),

		// Desativa extens√µes instaladas no navegador
		chromedp.Flag("disable-extensions", true),

		// ‚ùå REMOVIDO - bloqueava eventos de touch/pointer no Xorg!
		// chromedp.Flag("disable-plugins", true),

		// Desativa a barra de informa√ß√µes que diz "O Chrome est√° sendo controlado por software de teste automatizado"
		chromedp.Flag("disable-infobars", true),

		// Desativa o gerenciamento de temporizadores em segundo plano (para melhorar o desempenho)
		chromedp.Flag("disable-background-timer-throttling", true),

		// Desativa o fundo do renderizador (evita que o Chrome coloque a renderiza√ß√£o em segundo plano)
		chromedp.Flag("disable-renderer-backgrounding", true),

		// ‚ùå REMOVIDO - bloqueava WebSockets do Pusher!
		// chromedp.Flag("disable-background-networking", true),

		chromedp.Flag("hide-scrollbars", true),

		chromedp.Flag("enable-automation", false),
		// üé≠ ESCONDE DETEC√á√ÉO DE AUTOMA√á√ÉO (Anti-bot protection)
		chromedp.Flag("disable-blink-features", "AutomationControlled"),
		chromedp.Flag("exclude-switches", "enable-automation"),
		chromedp.Flag("disable-dev-shm-usage", true),

		// ‚úÖ FLAGS PARA COMPATIBILIDADE XORG/WAYLAND - Touch/Pointer Events
		// ‚ùå REMOVIDO - pode estar bloqueando eventos de input:
		// chromedp.Flag("enable-features", "TouchpadOverscrollHistoryNavigation"),
		chromedp.Flag("enable-blink-features", "PointerEvent,TouchEvents"),
		// ‚ùå REMOVIDO - pode estar bloqueando eventos de input:
		// chromedp.Flag("touch-events", "enabled"),

		// ‚úÖ FLAGS PARA MELHOR RENDERING (especialmente no Xorg)
		chromedp.Flag("use-gl", "desktop"),                        // Melhora rendering no Xorg
		chromedp.Flag("enable-accelerated-2d-canvas", true),       // Acelera canvas (jogos HTML5)
		chromedp.Flag("disable-gpu-driver-bug-workarounds", true), // Remove limita√ß√µes de GPU
	)

	// Se DevTools estiver habilitado, adiciona flags espec√≠ficas
	if enableDevTools {
		opts = append(opts,
			// Abre DevTools automaticamente
			chromedp.Flag("auto-open-devtools-for-tabs", true),
			// Inicia o navegador maximizado (n√£o fullscreen kiosk)
			chromedp.Flag("start-maximized", true),
		)
	}

	ctx, _ := chromedp.NewExecAllocator(globalCTX, opts...)

	ctx, cancel := chromedp.NewContext(
		ctx,
		// chromedp.WithDebugf(log.Printf),
	)

	// ‚úÖ Garante que ChromeDP N√ÉO ignore eventos de input do sistema
	if err := chromedp.Run(ctx, input.SetIgnoreInputEvents(false)); err != nil {
		log.Printf("Warning: Could not set ignore input events: %v", err)
	} else {
		log.Println("‚úÖ Input events habilitados no ChromeDP")
	}
	// üé≠ REMOVE navigator.webdriver e outras propriedades de detec√ß√£o de automa√ß√£o
	antiDetectionJS := `
		// Remove navigator.webdriver
		Object.defineProperty(navigator, 'webdriver', {
			get: () => false
		});

		// Remove chrome.runtime (presente apenas em extens√µes/automa√ß√£o)
		if (window.chrome && window.chrome.runtime) {
			delete window.chrome.runtime;
		}

		// Adiciona plugins fake (navegadores automatizados costumam ter 0 plugins)
		Object.defineProperty(navigator, 'plugins', {
			get: () => [1, 2, 3, 4, 5]
		});

		// Adiciona languages (navegadores automatizados costumam ter apenas 1)
		Object.defineProperty(navigator, 'languages', {
			get: () => ['en-US', 'en', 'pt-BR', 'pt']
		});

		console.log('üé≠ Anti-detection: navigator.webdriver =', navigator.webdriver);
	`
	// üé≠ Injeta script anti-detec√ß√£o ANTES de qualquer script da p√°gina
	if err := chromedp.Run(ctx, chromedp.ActionFunc(func(ctx context.Context) error {
		_, err := page.AddScriptToEvaluateOnNewDocument(antiDetectionJS).Do(ctx)
		return err
	})); err != nil {
		log.Printf("‚ö†Ô∏è  Warning: Could not inject anti-detection JS: %v", err)
	} else {
		log.Println("‚úÖ Anti-detection JS injetado (navigator.webdriver removido)")
	}

	if err := chromedp.Run(ctx, network.SetExtraHTTPHeaders(network.Headers(headers))); err != nil {
		log.Fatalf("Failed to set headers: %v", err)
		os.Exit(1)
	}

	// Start Chromium and navigate to the URL
	// Configura√ß√£o de viewport baseada em vari√°vel de ambiente

	var width, height int64
	var screenOrientationType emulation.OrientationType

	// Permite override manual via vari√°veis de ambiente
	if widthStr := os.Getenv("SCREEN_WIDTH"); widthStr != "" {
		width, _ = strconv.ParseInt(widthStr, 10, 64)
	}
	if heightStr := os.Getenv("SCREEN_HEIGHT"); heightStr != "" {
		height, _ = strconv.ParseInt(heightStr, 10, 64)
	}

	// Se n√£o foi especificado manualmente, usa preset baseado na orienta√ß√£o
	if width == 0 || height == 0 {
		if orientation == "landscape" {
			width = 1920 // Horizontal: 1920x1080
			height = 1080
			screenOrientationType = emulation.OrientationTypeLandscapePrimary
			log.Println("üì± Modo HORIZONTAL (landscape) - V√≠deo: Empire")
		} else {
			width = 1080 // Vertical: 1080x1920
			height = 1920
			screenOrientationType = emulation.OrientationTypePortraitPrimary
			log.Println("üì± Modo VERTICAL (portrait) - V√≠deo: Tigrinho")
		}
	} else {
		// Custom: detecta orienta√ß√£o baseado na propor√ß√£o
		if width > height {
			screenOrientationType = emulation.OrientationTypeLandscapePrimary
		} else {
			screenOrientationType = emulation.OrientationTypePortraitPrimary
		}
		log.Printf("üì± Modo CUSTOMIZADO - %dx%d", width, height)
	}

	log.Printf("üñ•Ô∏è  Configurando viewport: %dx%d (orienta√ß√£o: %s)", width, height, screenOrientationType)

	// JavaScript para for√ßar detec√ß√£o de orienta√ß√£o portrait
	forceOrientationJS := fmt.Sprintf(`
		(function() {
			// Override screen orientation
			Object.defineProperty(screen, 'width', { value: %d, writable: false });
			Object.defineProperty(screen, 'height', { value: %d, writable: false });
			Object.defineProperty(screen, 'availWidth', { value: %d, writable: false });
			Object.defineProperty(screen, 'availHeight', { value: %d, writable: false });

			// Override window dimensions
			Object.defineProperty(window, 'innerWidth', { value: %d, writable: false });
			Object.defineProperty(window, 'innerHeight', { value: %d, writable: false });
			Object.defineProperty(window, 'outerWidth', { value: %d, writable: false });
			Object.defineProperty(window, 'outerHeight', { value: %d, writable: false });

			// Override screen.orientation
			if (screen.orientation) {
				Object.defineProperty(screen.orientation, 'type', {
					value: '%s',
					writable: false
				});
				Object.defineProperty(screen.orientation, 'angle', {
					value: 0,
					writable: false
				});
			}

			// Override matchMedia para portrait
			const originalMatchMedia = window.matchMedia;
			window.matchMedia = function(query) {
				if (query.includes('orientation')) {
					if (query.includes('portrait') && '%s' === 'portrait-primary') {
						return { matches: true, media: query };
					}
					if (query.includes('landscape') && '%s' === 'landscape-primary') {
						return { matches: true, media: query };
					}
					return { matches: false, media: query };
				}
				return originalMatchMedia.call(this, query);
			};

			console.log('üîß Viewport for√ßado:', %d, 'x', %d);
			console.log('üîß Orienta√ß√£o for√ßada:', '%s');
		})();
	`, width, height, width, height, width, height, width, height,
		screenOrientationType, screenOrientationType, screenOrientationType,
		width, height, screenOrientationType)

	err := chromedp.Run(ctx,
		// Emula viewport com orienta√ß√£o
		emulation.SetDeviceMetricsOverride(int64(width), int64(height), 1.0, false).
			WithScreenOrientation(&emulation.ScreenOrientation{
				Type:  screenOrientationType,
				Angle: 0,
			}),

		// Injeta JavaScript ANTES de navegar
		chromedp.ActionFunc(func(ctx context.Context) error {
			return emulation.SetScriptExecutionDisabled(false).Do(ctx)
		}),

		// Navega para a URL
		chromedp.Navigate(url),

		// Aguarda um pouco para a p√°gina carregar
		chromedp.Sleep(2*time.Second),

		// Injeta o JavaScript de override
		chromedp.Evaluate(forceOrientationJS, nil),

		// Aguarda mais um pouco para garantir que o JS foi aplicado
		chromedp.Sleep(1*time.Second),
	)
	if err != nil {
		log.Fatalf("Error navigating to URL: %v", err)
		os.Exit(1)
	}

	log.Println("‚úÖ Viewport e orienta√ß√£o configurados com sucesso!")

	return ctx, cancel
}
